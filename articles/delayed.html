<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delaying code execution in Fiery • fiery</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Delaying code execution in Fiery">
<meta property="og:description" content="fiery">
<meta property="og:image" content="https://fiery.data-imaginist.com/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fiery</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1.4.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/events.html">The event cycle</a>
    </li>
    <li>
      <a href="../articles/delayed.html">Delaying code execution</a>
    </li>
    <li>
      <a href="../articles/plugins.html">Creating and using plugins</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Demos</li>
    <li>
      <a href="https://www.data-imaginist.com/2017/setting-fire-to-deployment/" class="external-link">Fiery on Heroku</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Release notes</li>
    <li>
      <a href="https://www.data-imaginist.com/2017/when-a-fire-starts-to-burn/" class="external-link">Version 1.0.0</a>
    </li>
    <li class="divider">
    </li>
<li>
      <a href="../news/index.html">Change log</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://reqres.data-imaginist.com" class="external-link">reqres</a>
</li>
<li>
  <a href="https://routr.data-imaginist.com" class="external-link">routr</a>
</li>
<li>
  <a href="https://github.com/thomasp85/fiery" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Delaying code execution in Fiery</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/thomasp85/fiery/blob/HEAD/vignettes/delayed.Rmd" class="external-link"><code>vignettes/delayed.Rmd</code></a></small>
      <div class="hidden name"><code>delayed.Rmd</code></div>

    </div>

    
    
<p>R, and thus fiery, is single threaded, meaning that every request must be handled one at a time. Because of this it is of utmost importance to keep the computation time for each request handling as low as possible so that the server does not become unresponsive. Still, sometimes you may need to perform long running computations as part of the server functionality. fiery comes with three different facilities for this, each with its own use case. All of them are build on top of the <a href="https://github.com/HenrikBengtsson/future" class="external-link">future</a> package.</p>
<div class="section level2">
<h2 id="general-format">General format<a class="anchor" aria-label="anchor" href="#general-format"></a>
</h2>
<p>All three methods have the same general API. They can recieve an expression to evaluate, as well as a <code>then</code> function to call once the evaluation eventually completes. The <code>then</code> function will recieve the result of the provided expression as well as the server itself. In general, any code that works on the server should be handled by the <code>then</code> function as the expression will not necessarily have access to the current environment. Thus, the expression should be as minimal as possible while still containing the heavy part of the calculations, while the <code>then</code> function should be used to act upon the result of the expression.</p>
<p>The general format is thus (using <code>delay()</code> as an example):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">app</span><span class="op">$</span><span class="fu">delay</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># Heavy calculation</span></span>
<span><span class="op">}</span>, then <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">res</span>, <span class="va">server</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Do something with 'res' (the result of the expression) and 'server' the </span></span>
<span>  <span class="co"># server object itself</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="pushing-execution-to-the-end-of-a-cycle">Pushing execution to the end of a cycle<a class="anchor" aria-label="anchor" href="#pushing-execution-to-the-end-of-a-cycle"></a>
</h2>
<p>If it is important to achieve a fast response time, but server congestion is of lesser concern (the server might be used for a local app with only one user at a time), the <code>delay()</code> method can be used to push the evaluation of long running computation to the end of the current cycle. It will of course not be possible to return the result of the computation as part of the response, but e.g. a <code>202</code> response can be returned instead indicating that the request is being processed. In that way the client can act accordingly without appearing frozen. An alternative if a lengthy POST request is recieved is to return <code>303</code> with a reference to the URL where the result can be recieved.</p>
</div>
<div class="section level2">
<h2 id="executing-in-another-process">Executing in another process<a class="anchor" aria-label="anchor" href="#executing-in-another-process"></a>
</h2>
<p>If long running computations are needed and congestion is an issue it does not help to simply push back execution to the end of the cycle as this will block requests while the code is evaluating. Instead it is possible to use the <code>async()</code> method to evaluate the expression in another thread. This method uses <code><a href="https://future.futureverse.org/reference/multiprocess.html" class="external-link">future::multiprocess()</a></code> to evaluate the expression and may thus fork the current R process if supported (Unix systems) or start another R session (Windows). At the end of each cycle all async evaluations are checked for completion, and if completed the <code>then</code> function will be called with the result. If the async evaluation is not completed it will continue to churn.</p>
</div>
<div class="section level2">
<h2 id="executing-after-a-time-interval">Executing after a time interval<a class="anchor" aria-label="anchor" href="#executing-after-a-time-interval"></a>
</h2>
<p>If code is meant to be evaluated after a certain amount of time has passed, use the <code><a href="https://rdrr.io/r/stats/time.html" class="external-link">time()</a></code> method. In addition to <code>expr</code> and <code>then</code>, <code><a href="https://rdrr.io/r/stats/time.html" class="external-link">time()</a></code> takes two additional arguments: <code>after</code> (the time in seconds to wait before evaluation) and <code>loop</code> (whether to repeat the timed evaluation after completion). Using <code>loop = TRUE</code> it is e.g. possible to continually check for state changes on the server and e.g. run some specific code if new files appear in a directory. In the end of each cycle all timed expressions will be checked for whether they should be evaluated and run if their specific time interval has passed.</p>
</div>
<div class="section level2">
<h2 id="error-handling">Error handling<a class="anchor" aria-label="anchor" href="#error-handling"></a>
</h2>
<p>As both the expression and <code>then</code> function might throw errors they are evaluated in a safe context and any errors that might occur will be send to the server log without affecting other waiting evaluations.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://data-imaginist.com" class="external-link">Thomas Lin Pedersen</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
