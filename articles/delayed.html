<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Delaying code execution in Fiery • fiery</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Delaying code execution in Fiery">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fiery</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/events.html">The event cycle</a></li>
    <li><a class="dropdown-item" href="../articles/delayed.html">Delaying code execution</a></li>
    <li><a class="dropdown-item" href="../articles/plugins.html">Creating and using plugins</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Demos</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.data-imaginist.com/2017/setting-fire-to-deployment/">Fiery on Heroku</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Release notes</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.data-imaginist.com/2017/when-a-fire-starts-to-burn/">Version 1.0.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Change log</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://reqres.data-imaginist.com">reqres</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://routr.data-imaginist.com">routr</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/thomasp85/fiery"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Delaying code execution in Fiery</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/thomasp85/fiery/blob/main/vignettes/delayed.Rmd" class="external-link"><code>vignettes/delayed.Rmd</code></a></small>
      <div class="d-none name"><code>delayed.Rmd</code></div>
    </div>

    
    
<p>R, and thus fiery, is single threaded, meaning that every request
must be handled one at a time. Because of this it is of utmost
importance to keep the computation time for each request handling as low
as possible so that the server does not become unresponsive. Still,
sometimes you may need to perform long running computations as part of
the server functionality. fiery comes with three different facilities
for this, each with its own use case. All of them are build on top of
the <a href="https://github.com/HenrikBengtsson/future" class="external-link">future</a>
package.</p>
<div class="section level2">
<h2 id="general-format">General format<a class="anchor" aria-label="anchor" href="#general-format"></a>
</h2>
<p>All three methods have the same general API. They can recieve an
expression to evaluate, as well as a <code>then</code> function to call
once the evaluation eventually completes. The <code>then</code> function
will recieve the result of the provided expression as well as the server
itself. In general, any code that works on the server should be handled
by the <code>then</code> function as the expression will not necessarily
have access to the current environment. Thus, the expression should be
as minimal as possible while still containing the heavy part of the
calculations, while the <code>then</code> function should be used to act
upon the result of the expression.</p>
<p>The general format is thus (using <code>delay()</code> as an
example):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">app</span><span class="op">$</span><span class="fu">delay</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># Heavy calculation</span></span>
<span><span class="op">}</span>, then <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">res</span>, <span class="va">server</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Do something with 'res' (the result of the expression) and 'server' the </span></span>
<span>  <span class="co"># server object itself</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="pushing-execution-to-the-end-of-a-cycle">Pushing execution to the end of a cycle<a class="anchor" aria-label="anchor" href="#pushing-execution-to-the-end-of-a-cycle"></a>
</h2>
<p>If it is important to achieve a fast response time, but server
congestion is of lesser concern (the server might be used for a local
app with only one user at a time), the <code>delay()</code> method can
be used to push the evaluation of long running computation to the end of
the current cycle. It will of course not be possible to return the
result of the computation as part of the response, but e.g. a
<code>202</code> response can be returned instead indicating that the
request is being processed. In that way the client can act accordingly
without appearing frozen. An alternative if a lengthy POST request is
recieved is to return <code>303</code> with a reference to the URL where
the result can be recieved.</p>
</div>
<div class="section level2">
<h2 id="executing-in-another-process">Executing in another process<a class="anchor" aria-label="anchor" href="#executing-in-another-process"></a>
</h2>
<p>If long running computations are needed and congestion is an issue it
does not help to simply push back execution to the end of the cycle as
this will block requests while the code is evaluating. Instead it is
possible to use the <code>async()</code> method to evaluate the
expression in another thread. This method uses
<code>future::multiprocess()</code> to evaluate the expression and may
thus fork the current R process if supported (Unix systems) or start
another R session (Windows). At the end of each cycle all async
evaluations are checked for completion, and if completed the
<code>then</code> function will be called with the result. If the async
evaluation is not completed it will continue to churn.</p>
</div>
<div class="section level2">
<h2 id="executing-after-a-time-interval">Executing after a time interval<a class="anchor" aria-label="anchor" href="#executing-after-a-time-interval"></a>
</h2>
<p>If code is meant to be evaluated after a certain amount of time has
passed, use the <code><a href="https://rdrr.io/r/stats/time.html" class="external-link">time()</a></code> method. In addition to
<code>expr</code> and <code>then</code>, <code><a href="https://rdrr.io/r/stats/time.html" class="external-link">time()</a></code> takes two
additional arguments: <code>after</code> (the time in seconds to wait
before evaluation) and <code>loop</code> (whether to repeat the timed
evaluation after completion). Using <code>loop = TRUE</code> it is
e.g. possible to continually check for state changes on the server and
e.g. run some specific code if new files appear in a directory. In the
end of each cycle all timed expressions will be checked for whether they
should be evaluated and run if their specific time interval has
passed.</p>
</div>
<div class="section level2">
<h2 id="error-handling">Error handling<a class="anchor" aria-label="anchor" href="#error-handling"></a>
</h2>
<p>As both the expression and <code>then</code> function might throw
errors they are evaluated in a safe context and any errors that might
occur will be send to the server log without affecting other waiting
evaluations.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://data-imaginist.com" class="external-link">Thomas Lin Pedersen</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
