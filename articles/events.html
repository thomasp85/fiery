<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>The event cycle in fiery • fiery</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="The event cycle in fiery">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fiery</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/events.html">The event cycle</a></li>
    <li><a class="dropdown-item" href="../articles/plugins.html">Creating and using plugins</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Demos</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.data-imaginist.com/2017/setting-fire-to-deployment/">Fiery on Heroku</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Release notes</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.data-imaginist.com/2017/when-a-fire-starts-to-burn/">Version 1.0.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Change log</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://reqres.data-imaginist.com">reqres</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://routr.data-imaginist.com">routr</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/thomasp85/fiery"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>The event cycle in fiery</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/thomasp85/fiery/blob/main/vignettes/events.Rmd" class="external-link"><code>vignettes/events.Rmd</code></a></small>
      <div class="d-none name"><code>events.Rmd</code></div>
    </div>

    
    
<p>fiery is using an event-based model to allow you to program the
logic. During the life cycle of an app a range of different events will
be triggered and it is possible to add event handlers to these using the
<code>on()</code> method. An event handler is simply a function that
will get called every time an event is fired. Apart from the predefined
life cycle events it is also possible to trigger custom events using the
<code>trigger()</code> method. Manual triggering of life cycle events is
not allowed.</p>
<div class="section level2">
<h2 id="life-cycle-events">Life cycle Events<a class="anchor" aria-label="anchor" href="#life-cycle-events"></a>
</h2>
<p>Following is a list of all life cycle events. These cannot be
triggered manually, but is fired as part of the normal lifetime of a
fiery server:</p>
<ul>
<li>
<code>start</code>: Will trigger once when the app is started but
before it is running. The handlers will receive the app itself as the
<code>server</code> argument as well as any argument passed on from the
<code>ignite()</code> method. Any return value is discarded.</li>
<li>
<code>resume</code>: Will trigger once after the start event if the
app has been started using the <code>reignite()</code> method. The
handlers will receive the app itself as the <code>server</code> argument
as well as any argument passed on from the <code>reignite()</code>
method. Any return value is discarded.</li>
<li>
<code>end</code>: Will trigger once after the app is stopped. The
handlers will receive the app itself as the <code>server</code>
argument. Any return value is discarded.</li>
<li>
<code>cycle-start</code>: Will trigger in the beginning of each
loop, before the request queue is flushed. The handlers will receive the
app itself as the <code>server</code> argument. Any return value is
discarded.</li>
<li>
<code>cycle-end</code>: Will trigger in the end of each loop, after
the request queue is flushed and all delayed, timed, and asynchronous
calls have been executed. The handlers will receive the app itself as
the <code>server</code> argument. Any return value is discarded.</li>
<li>
<code>header</code>: Will trigger every time the header of a request
is received. The return value of the last called handler is used to
determine if further processing of the request will be done. If the
return value is <code>TRUE</code> the request will continue on to normal
processing. If the return value is <code>FALSE</code> the response will
be send back and the connection will be closed without retrieving the
payload. The handlers will receive the app itself as the
<code>server</code> argument, the client id as the <code>id</code>
argument and the request object as the <code>request</code>
argument.</li>
<li>
<code>before-request</code>: Will trigger prior to handling of a
request (that is, every time a request is received unless it is
short-circuited by the <code>header</code> handlers). The return values
of the handlers will be passed on to the request handlers and can thus
be used to inject data into the request handlers (e.g. session specific
data). The handlers will receive the app itself as the
<code>server</code> argument, the client id as the <code>id</code>
argument and the request object as the <code>request</code>
argument.</li>
<li>
<code>request</code>: Will trigger after the
<code>before-request</code> event. This is where the main request
handling is done. The return value of the last handler is send back to
the client as response. If no handler is registered a <code>404</code>
error is returned automatically. If the return value is not a valid
response, a <code>500</code> server error is returned instead. The
handlers will receive the app itself as the <code>server</code>
argument, the client id as the <code>id</code> argument, the request
object as the <code>request</code> argument, and the list of values
created by the before-event handlers as the <code>arg_list</code>
argument.</li>
<li>
<code>after-request</code>: Will trigger after the
<code>request</code> event. This can be used to inspect the response
(but not modify it) before it is send to the client. The handlers will
receive the app itself as the <code>server</code> argument, the client
id as the <code>id</code> argument, the request object as the
<code>request</code> argument, and the response as the
<code>response</code> argument. Any return value is discarded.</li>
<li>
<code>before-message</code>: This event is triggered when a
websocket message is received. As with the <code>before-request</code>
event the return values of the handlers are passed on to the
<code>message</code> handlers. Specifically if a <code>'binary'</code>
and <code>'message'</code> value is returned they will override the
original values in the <code>message</code> and
<code>after-message</code> handler arguments. This can e.g. be used to
decode the message once before passing it through the
<code>message</code> handlers. The <code>before-message</code> handlers
will receive the app itself as the <code>server</code> argument, the
client id as the <code>id</code> argument, a flag indicating whether the
message is binary as the <code>binary</code> argument, the message
itself as the <code>message</code> argument, and the request object used
to establish the connection with the client as the <code>request</code>
argument.</li>
<li>
<code>message</code>: This event is triggered after the
<code>before-message</code> event and is used for the primary websocket
message handling. As with the <code>request</code> event, the handlers
for the <code>message</code> event receives the return values from the
<code>before-message</code> handlers which can be used to e.g. inject
session specific data. The message handlers will receive the app itself
as the <code>server</code> argument, the client id as the
<code>id</code> argument, a flag indicating whether the message is
binary as the <code>binary</code> argument, the message itself as the
<code>message</code> argument, the request object used to establish the
connection with the client as the <code>request</code> argument, and the
values returned by the before-message handlers as the
<code>arg_list</code> argument. Contrary to the <code>request</code>
event the return values of the handlers are ignored as websocket
communication is bidirectional.</li>
<li>
<code>after-message</code>: This event is triggered after the
<code>message</code> event. It is provided more as an equivalent to the
<code>after-request</code> event than out of necessity as there is no
final response to inspect and handler can thus just as well be attached
to the <code>message</code> event. For clear division of server logic,
message specific handlers should be attached to the <code>message</code>
event, whereas general handlers should, if possible, be attached to the
<code>after-message</code> event. The <code>after-message</code>
handlers will receive the app itself as the <code>server</code>
argument, the client id as the <code>id</code> argument, a flag
indicating whether the message is binary as the <code>binary</code>
argument, the message itself as the <code>message</code> argument, and
the request object used to establish the connection with the client as
the <code>request</code> argument.</li>
<li>
<code>send</code>: This event is triggered after a websocket message
is send to a client. The handlers will receive the app itself as the
<code>server</code> argument, the client id as the <code>id</code>
argument and the send message as the <code>message</code> argument. Any
return value is discarded.</li>
<li>
<code>websocket-opened</code>: This event is triggered when a client
tries to establish a WebSocket connection to the server. The handler
will receive the app itself as the <code>server</code> argument, the
client id as the <code>id</code> argument, and the WebSocket class
provided by httpuv as the <code>connection</code> argument. Any return
value is discarded. Since this event exposes logic from the httpuv
package through the <code>connection</code> argument it is liable to
changes in the httpuv API.</li>
<li>
<code>websocket-closed</code>: This event will be triggered every
time a websocket connection is closed. The handlers will receive the app
itself as the <code>server</code> argument, the client id as the
<code>id</code> argument and request used to establish the closed
connection as the <code>request</code> argument. Any return value is
discarded.</li>
</ul>
</div>
<div class="section level2">
<h2 id="custom-events">Custom Events<a class="anchor" aria-label="anchor" href="#custom-events"></a>
</h2>
<p>Apart from the predefined events, it is also possible to trigger and
listen to custom events. The syntax is as follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add a handler to the 'new-event' event</span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="va">app</span><span class="op">$</span><span class="fu">on</span><span class="op">(</span><span class="st">'new-event'</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">'Event fired'</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Trigger the event</span></span>
<span><span class="va">app</span><span class="op">$</span><span class="fu">trigger</span><span class="op">(</span><span class="st">'new-event'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove the handler</span></span>
<span><span class="va">app</span><span class="op">$</span><span class="fu">off</span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span></code></pre></div>
<p>Additional parameters passed on to the <code>trigger()</code> method
will be passed on to the handler. There is no limit to the number of
handlers that can be attached to custom events. When an event is
triggered they will simply be called in the order they have been added.
Triggering a non-existing event is not an error, so plugins are free to
fire off events without worrying about whether handlers have been
added.</p>
</div>
<div class="section level2">
<h2 id="triggering-events-externally">Triggering Events Externally:<a class="anchor" aria-label="anchor" href="#triggering-events-externally"></a>
</h2>
<p>If a fiery server is running in blocking mode it is not possible to
communicate with it using the <code>trigger()</code> method (though
these can be fired by other callbacks in the server logic). Instead it
is possible to assign a directory to look in for event trigger
instructions. The trigger directory is set using the
<code>trigger_dir</code> field, e.g.:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">app</span><span class="op">$</span><span class="va">trigger_dir</span> <span class="op">&lt;-</span> <span class="st">'/some/path/to/dir/'</span></span></code></pre></div>
<p>Events are triggered by placing an <code>rds</code> file named after
the event in the trigger directory. The file must contain a list, and
the elements of the list will be passed on as arguments to the event
handlers. After the event has been triggered the file will be deleted.
The following command will trigger the <code>external-event</code> on a
server looking in <code>'/some/path/to/dir/'</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>arg1 <span class="op">=</span> <span class="st">'test'</span><span class="op">)</span>, <span class="st">'/some/path/to/dir/external-event.rds'</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://data-imaginist.com" class="external-link">Thomas Lin Pedersen</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
